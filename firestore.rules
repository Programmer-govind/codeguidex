rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
             (request.auth.token.email == 'admin448@codeguidex.com' ||
              (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
    }

    // Allow authenticated users to read and write their own user documents
    // Admin can read/write all users
    match /users/{userId} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Allow authenticated users to read communities
    match /communities/{communityId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (request.auth.uid == resource.data.createdBy || isAdmin());
    }

    // Allow authenticated users to read and write posts in communities they can access
    match /communities/{communityId}/posts/{postId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (request.auth.uid == resource.data.authorId || isAdmin());
    }

    // Allow authenticated users to read and write comments on posts
    match /communities/{communityId}/posts/{postId}/comments/{commentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (request.auth.uid == resource.data.authorId || isAdmin());
    }

    // Allow authenticated users to read and write user-community relationships
    match /userCommunityJoins/{joinId} {
      allow read, write: if request.auth != null || isAdmin();
    }

    // Allow authenticated users to read and write post votes
    match /userPostVotes/{voteId} {
      allow read, write: if request.auth != null || isAdmin();
    }

    // Allow authenticated users to read and write post views
    match /userPostViews/{viewId} {
      allow read, write: if request.auth != null || isAdmin();
    }
  }
}